<!DOCTYPE html>
<html>

<head>
    <title>CRS.Simple example - Leaflet</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <script src="js/coords.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="js/buffer.js"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100vw;
            height: 100vh;
            background-image: url(img/PikPng.com_clouds-png_2601954.png);

        }
    </style>
</head>

<body>

    <div id='map'></div>
    <script>

        const drawPoly = [];
        //for development only 
        const mainData = {
            data: {},
            markers: []
        };
        const img = {
            x: 6300,  // original width of image 
            y: 4008   // original height of image
        }

        // create the map
        var map = L.map('map', {
            // crs: L.CRS.Simple,
            maxZoom: 5,
            minZoom: 3,
            zoomControl: false,
            //preferCanvas: true,
            noWrap: true,
            edgeBufferTiles: 20,
            //inertia: false
        })

        var rc = new L.RasterCoords(map, [img.x, img.y])

        var mapBounds = new L.LatLngBounds(
            rc.unproject([1, img.y], 8),
            rc.unproject([img.x, 1], 8)
        );

        // assign map and image dimensions
        map.setView(rc.unproject([img.x / 2, img.y / 2]), 2)
        map.setZoom(2)

        const tileLayer = L.tileLayer('//80.209.224.236/~serg/leaflet-fantasy-game/{z}/{x}/{y}.png', {
            noWrap: true,
            preferCanvas: true,
            bounds: mapBounds
        }).addTo(map)

        L.control.zoom({ position: 'topright' }).addTo(map);
        // const label = L.marker(rc.unproject([img.x / 2, img.y / 2])).addTo(map)

        map.on("click", e => {
            const c = rc.project(e.latlng);
            console.log('c', e.latlng, c);
            const { x, y } = c
            drawPoly.push(c)
        })


        fetch("data/data.json").then(data => data.json()).then(json => {
            console.log('json', json);
            //TOWNS
            json.towns.forEach(town => {
                drawPolygon({
                    coords: town.polygon,
                    data: town
                })
            })
        })

        function unproject(arr) {
            const { lat, lng } = rc.unproject(arr)
            return [lng, lat]
        }


        function drawPolygon({ coords, color = "white", dashArray = false, data }) {

            const popupContent = `
            <h1>${data.name}</h1>
                <div class="type">
                    Type: ${data.type}
                </div>
                <div class="type">
                    Info: ${data.info}
                </div>
                `

            const unpCoords = coords.map(c => {
                return rc.unproject([c.x, c.y])
            })

            const polygon = L.polygon(unpCoords, {
                color,
                "fillOpacity": 0,
                dashArray: dashArray ? '5,10' : '',
                "opacity": 0.1
            });

            polygon.on('click', function (e) {
                console.log('e', e, data);


                L.popup()
                    .setLatLng(e.latlng)
                    .setContent(popupContent)
                    .openOn(map);
            });

            polygon.addTo(map);
            return polygon;
        }

    </script>
</body>

</html>